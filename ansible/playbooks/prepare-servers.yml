---
- name: Prepare servers for automation (disable apt auto-updates safely)
  hosts: all
  become: true
  gather_facts: true

  tasks:

    - name: Kill cloud-init and unattended-upgrade processes
      shell: pkill -9 -f cloud-init || true; pkill -9 -f unattended-upgrade || true
      changed_when: false
      ignore_errors: true

    - name: Wait for apt locks to clear
      wait_for:
        path: /var/lib/apt/lists/lock
        state: absent
        timeout: 60
      ignore_errors: true

    - name: Stop and disable apt timers and services
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
        masked: true
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer
        - apt-daily
        - apt-daily-upgrade
        - unattended-upgrades
      ignore_errors: true

    - name: Fix dpkg if in inconsistent state
      command: dpkg --configure -a
      changed_when: false
      ignore_errors: true

    - name: Remove unattended-upgrades package
      apt:
        name: unattended-upgrades
        state: absent
      ignore_errors: true

    - name: Disable periodic apt updates
      copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: '0644'
        content: |
          APT::Periodic::Update-Package-Lists "0";
          APT::Periodic::Unattended-Upgrade "0";
          APT::Periodic::Download-Upgradeable-Packages "0";
          APT::Periodic::AutocleanInterval "0";
      ignore_errors: true

    - name: Create update-manager directory if needed
      file:
        path: /etc/update-manager
        state: directory
        mode: '0755'
      ignore_errors: true

    - name: Disable release upgrade prompts
      copy:
        dest: /etc/update-manager/release-upgrades
        owner: root
        group: root
        mode: '0644'
        content: |
          [DEFAULT]
          Prompt=never
      ignore_errors: true

    - name: Verify apt is ready
      command: apt --version
      changed_when: false
